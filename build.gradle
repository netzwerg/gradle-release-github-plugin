import org.apache.tools.ant.filters.ReplaceTokens

apply plugin: 'groovy'
apply plugin: ReleaseGitHubPlugin

group = 'ch.netzwerg'

repositories {
    jcenter()
}

release {
    github {
        repo = 'git-playground'
        user = 'netzwerg'
        password = "$GITHUB_PASSWORD"
        tokens = [tagName: project.version]
    }
}

class ReleaseGitHubPlugin implements Plugin<Project> {

    @Override
    void apply(Project project) {
        project.extensions.create('release', ReleaseGitHubExtension.class)
        project.tasks.create('releaseOnGitHub', ReleaseGitHubTask)
    }

}

class ReleaseGitHubExtension {

    String repo
    String user
    String password
    Map<String, String> tokens

    def github(Closure closure) {
        closure.delegate = this
        closure()
    }

}

class ReleaseGitHubTask extends DefaultTask {

    private static final String JSON_FILE_NAME = 'release-github.json'

    @TaskAction
    def release() {
        ReleaseGitHubExtension releaseExtension = project.getExtensions().getByType(ReleaseGitHubExtension.class)
        project.copy {
            from JSON_FILE_NAME
            into getTemporaryDir()
            filter(ReplaceTokens, tokens: releaseExtension.tokens)
        }
        project.exec {
            executable 'curl'
            args '-X', 'POST',
                 '-u', "$releaseExtension.user:$releaseExtension.password",
                 '--data-binary', '@' + getTemporaryDir() + File.separator + JSON_FILE_NAME,
                 "https://api.github.com/repos/$releaseExtension.user/$releaseExtension.repo/releases"
        }
    }

}